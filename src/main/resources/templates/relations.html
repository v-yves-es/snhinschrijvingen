<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Relaties - SPES Nostra Heule</title>
    <link rel="stylesheet" th:href="@{/css/snh-style.css}">
    <link rel="stylesheet" th:href="@{/css/select2.min.css}">
    <link rel="stylesheet" th:href="@{/css/select2-custom.css}">
</head>
<body>
    <section class="wizard-container">
            <div class="container">
                <div class="form-card">
                    <h1 class="form-title">Relaties</h1>
                    
                    <form class="form" 
                          th:action="@{/inschrijving/relaties/__${registrationId}__}" 
                          method="post" 
                          th:object="${relationsForm}" 
                          data-validate="true" 
                          novalidate>
                        
                        <!-- Hidden registration ID -->
                        <input type="hidden" name="id" th:value="${registrationId}">
                        
                        <!-- Wizard Progress -->
                        <div th:replace="~{fragments/wizard :: wizard}"></div>
                        
                        <!-- Relation 1 (Always visible) -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <h2 class="form-section-title">Relatie 1 (verplicht)</h2>
                            </div>
                            
                            <!-- Relation Type -->
                            <div class="position-relative mb-3">
                                <label for="relation1Type" class="form-label">Type relatie</label>
                                <select id="relation1Type" 
                                        th:field="*{relation1.relationType}" 
                                        class="form-control select2"
                                        data-placeholder="Selecteer een type relatie"
                                        data-no-scroll="true"
                                        required>
                                    <option value="">-- Selecteer --</option>
                                    <option value="13">Vader</option>
                                    <option value="14">Moeder</option>
                                    <option value="5">Plusvader</option>
                                    <option value="6">Plusmoeder</option>
                                    <option value="2">Voogd</option>
                                    <option value="9">Grootvader</option>
                                    <option value="10">Grootmoeder</option>
                                    <option value="7">Pleegvader</option>
                                    <option value="8">Pleegmoeder</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Name fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation1FirstName" class="form-label">Voornaam</label>
                                        <input type="text" 
                                               id="relation1FirstName"
                                               th:field="*{relation1.firstName}" 
                                               class="form-control" 
                                               placeholder="Voornaam"
                                               required>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation1LastName" class="form-label">Naam</label>
                                        <input type="text" 
                                               id="relation1LastName"
                                               th:field="*{relation1.lastName}" 
                                               class="form-control" 
                                               placeholder="Naam"
                                               required>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation1Phone" class="form-label">Telefoonnummer</label>
                                        <input type="tel" 
                                               id="relation1Phone"
                                               th:field="*{relation1.phone}" 
                                               class="form-control" 
                                               placeholder="+32 4XX XX XX XX"
                                               data-validate="phone"
                                               required>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation1Email" class="form-label">E-mailadres</label>
                                        <input type="email" 
                                               id="relation1Email"
                                               th:field="*{relation1.email}" 
                                               class="form-control" 
                                               placeholder="naam@voorbeeld.be"
                                               data-validate="email"
                                               required>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Address fields using fragment -->
                            <div class="form-section-header">
                                <h3 class="form-section-subtitle">Adres</h3>
                                <button type="button" class="btn btn--outline btn--small copy-address-btn" onclick="copyDomicileAddress('relation1')">
                                    Domicilieadres overnemen
                                </button>
                            </div>
                            <div th:replace="~{fragments/address-fields :: addressFields('relation1.address', ${relationsForm.relation1.address}, true)}"></div>
                        </div>
                        
                        <!-- Add Second Relation Button -->
                        <div class="form-section" id="addRelation2Section">
                            <button type="button" class="btn btn--outline" id="addRelation2Btn">
                                <svg class="btn__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M8 1V15M1 8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Tweede relatie toevoegen
                            </button>
                        </div>
                        
                        <!-- Relation 2 (Optional, shown after clicking add button) -->
                        <div class="form-section" id="relation2Section" style="display: none;">
                            <div class="form-section-header">
                                <h2 class="form-section-title">Relatie 2 (optioneel)</h2>
                                <button type="button" class="btn btn--outline btn--small" id="removeRelation2Btn">
                                    <svg class="btn__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 4L12 12M4 12L12 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Verwijderen
                                </button>
                            </div>
                            
                            <!-- Hidden field to track if relation 2 is shown -->
                            <input type="hidden" th:field="*{showRelation2}" id="showRelation2Field">
                            
                            <!-- Relation Type -->
                            <div class="position-relative mb-3">
                                <label for="relation2Type" class="form-label">Type relatie</label>
                                <select id="relation2Type" 
                                        th:field="*{relation2.relationType}" 
                                        class="form-control select2"
                                        data-placeholder="Selecteer een type relatie"
                                        data-no-scroll="true">
                                    <option value="">-- Selecteer --</option>
                                    <option value="13">Vader</option>
                                    <option value="14">Moeder</option>
                                    <option value="5">Plusvader</option>
                                    <option value="6">Plusmoeder</option>
                                    <option value="2">Voogd</option>
                                    <option value="9">Grootvader</option>
                                    <option value="10">Grootmoeder</option>
                                    <option value="7">Pleegvader</option>
                                    <option value="8">Pleegmoeder</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Name fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation2FirstName" class="form-label">Voornaam</label>
                                        <input type="text" 
                                               id="relation2FirstName"
                                               th:field="*{relation2.firstName}" 
                                               class="form-control" 
                                               placeholder="Voornaam">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation2LastName" class="form-label">Naam</label>
                                        <input type="text" 
                                               id="relation2LastName"
                                               th:field="*{relation2.lastName}" 
                                               class="form-control" 
                                               placeholder="Naam">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation2Phone" class="form-label">Telefoonnummer</label>
                                        <input type="tel" 
                                               id="relation2Phone"
                                               th:field="*{relation2.phone}" 
                                               class="form-control" 
                                               placeholder="+32 4XX XX XX XX"
                                               data-validate="phone">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label for="relation2Email" class="form-label">E-mailadres</label>
                                        <input type="email" 
                                               id="relation2Email"
                                               th:field="*{relation2.email}" 
                                               class="form-control" 
                                               placeholder="naam@voorbeeld.be"
                                               data-validate="email">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Address fields using fragment -->
                            <div class="form-section-header">
                                <h3 class="form-section-subtitle">Adres</h3>
                                <button type="button" class="btn btn--outline btn--small copy-address-btn" onclick="copyDomicileAddress('relation2')">
                                    Domicilieadres overnemen
                                </button>
                            </div>
                            <div th:replace="~{fragments/address-fields :: addressFields('relation2.address', ${relationsForm.relation2.address}, false)}"></div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div th:replace="~{fragments/navigation :: navigation(@{/inschrijving/vorige-school/__${registrationId}__}, 'Vorige', 'Volgende', true)}"></div>
                    </form>
                    
                    <!-- Relations-specific JavaScript -->
                    <script th:inline="javascript">
                        console.log('=== RELATIONS SCRIPT LOADING ===');
                        
                        // Domicile address data from Registration entity - make global
                        window.domicileAddress = {
                            straat: /*[[${registration.studentAddress?.street}]]*/ '',
                            huisnr: /*[[${registration.studentAddress?.houseNumber}]]*/ '',
                            bus: /*[[${registration.studentAddress?.box}]]*/ '',
                            postcode: /*[[${registration.studentAddress?.postalCode}]]*/ '',
                            gemeente: /*[[${registration.studentAddress?.city}]]*/ '',
                            land: /*[[${registration.studentAddress?.country}]]*/ 'BelgiÃ«'
                        };
                        
                        console.log('Domicile address loaded:', window.domicileAddress);
                        
                        // Make function global
                        window.copyDomicileAddress = function(relationPrefix) {
                            console.log('Copying domicile address to', relationPrefix);
                            console.log('Source data:', window.domicileAddress);
                            
                            // Map field names
                            const fields = {
                                straat: relationPrefix + '.address.street',
                                huisnr: relationPrefix + '.address.houseNumber',
                                bus: relationPrefix + '.address.box',
                                postcode: relationPrefix + '.address.postalCode',
                                gemeente: relationPrefix + '.address.city',
                                land: relationPrefix + '.address.country'
                            };
                            
                            // Copy values to relation address fields
                            Object.keys(fields).forEach(key => {
                                const fieldName = fields[key];
                                const input = document.querySelector(`[name="${fieldName}"]`);
                                console.log(`Field: ${fieldName}, Input:`, input, `Value: ${window.domicileAddress[key]}`);
                                if (input) {
                                    input.value = window.domicileAddress[key] || '';
                                    
                                    // Mark field as touched and remove invalid state
                                    input.dataset.touched = 'true';
                                    input.classList.remove('is-invalid');
                                    
                                    // If field has value, mark as valid
                                    if (input.value && input.value.trim() !== '') {
                                        input.classList.add('is-valid');
                                        // Hide error message
                                        const feedback = input.parentElement.querySelector('.invalid-feedback');
                                        if (feedback) {
                                            feedback.style.display = 'none';
                                        }
                                    }
                                    
                                    // Trigger validation to update state
                                    const event = new Event('input', { bubbles: true });
                                    input.dispatchEvent(event);
                                }
                            });
                            
                            console.log('Domicile address copied successfully');
                        };
                        
                        function initRelationsToggle() {
                            console.log('Init relations toggle');
                            
                            const addBtn = document.getElementById('addRelation2Btn');
                            const removeBtn = document.getElementById('removeRelation2Btn');
                            const relation2Section = document.getElementById('relation2Section');
                            const addSection = document.getElementById('addRelation2Section');
                            const showRelation2Field = document.getElementById('showRelation2Field');
                            
                            console.log('addBtn:', addBtn ? 'FOUND' : 'NOT FOUND');
                            console.log('relation2Section:', relation2Section ? 'FOUND' : 'NOT FOUND');
                            console.log('showRelation2Field value:', showRelation2Field ? showRelation2Field.value : 'NOT FOUND');
                            
                            if (!addBtn || !relation2Section || !addSection) {
                                console.error('Required elements not found!');
                                return;
                            }
                            
                            // Check if relation2 should be shown (existing data from server)
                            const shouldShowRelation2 = showRelation2Field && (showRelation2Field.value === 'true' || showRelation2Field.value === 'True');
                            
                            if (shouldShowRelation2) {
                                console.log('Showing relation2 section - has existing data');
                                relation2Section.style.display = 'block';
                                addSection.style.display = 'none';
                                
                                // Make fields required
                                document.getElementById('relation2Type').required = true;
                                document.getElementById('relation2FirstName').required = true;
                                document.getElementById('relation2LastName').required = true;
                                document.getElementById('relation2Phone').required = true;
                                document.getElementById('relation2Email').required = true;
                                
                                // Make address fields required (except box)
                                relation2Section.querySelectorAll('input[name^="relation2.address"]').forEach(function(field) {
                                    if (!field.name.includes('.box')) {
                                        field.required = true;
                                    }
                                });
                                
                                // Initialize Select2 for relation2
                                setTimeout(function() {
                                    if (window.jQuery && window.jQuery.fn.select2) {
                                        jQuery('#relation2Type').select2({
                                            theme: 'classic',
                                            width: '100%',
                                            placeholder: 'Selecteer een type relatie',
                                            minimumResultsForSearch: -1,
                                            allowClear: false,
                                            dropdownCssClass: 'select2-dropdown-no-scroll'
                                        });
                                    }
                                }, 100);
                            } else {
                                console.log('Disabling validation for hidden relation2 section');
                                // Remove required from all relation2 fields
                                ['relation2Type', 'relation2FirstName', 'relation2LastName', 'relation2Phone', 'relation2Email'].forEach(function(id) {
                                    const el = document.getElementById(id);
                                    if (el) {
                                        el.required = false;
                                        // Clear any validation states
                                        el.classList.remove('is-valid', 'is-invalid');
                                    }
                                });
                                // Remove required from all relation2 address fields (except box which is never required)
                                relation2Section.querySelectorAll('input[name^="relation2.address"]').forEach(function(field) {
                                    field.required = false;
                                    // Clear any validation states
                                    field.classList.remove('is-valid', 'is-invalid');
                                });
                            }
                            
                            addBtn.onclick = function(e) {
                                console.log('=== ADD BUTTON CLICKED ===');
                                e.preventDefault();
                                
                                relation2Section.style.display = 'block';
                                addSection.style.display = 'none';
                                if (showRelation2Field) showRelation2Field.value = 'true';
                                
                                // Make relation2 fields required when visible (except box)
                                document.getElementById('relation2Type').required = true;
                                document.getElementById('relation2FirstName').required = true;
                                document.getElementById('relation2LastName').required = true;
                                document.getElementById('relation2Phone').required = true;
                                document.getElementById('relation2Email').required = true;
                                
                                // Make relation2 address fields required (except box which is never required)
                                relation2Section.querySelectorAll('input[name^="relation2.address"]').forEach(function(field) {
                                    if (!field.name.includes('.box')) {
                                        field.required = true;
                                    }
                                });
                                
                                // Initialize Select2 for relation2 after it becomes visible
                                setTimeout(function() {
                                    if (window.jQuery && window.jQuery.fn.select2) {
                                        jQuery('#relation2Type').select2({
                                            theme: 'classic',
                                            width: '100%',
                                            placeholder: 'Selecteer een type relatie',
                                            minimumResultsForSearch: -1,
                                            allowClear: false,
                                            dropdownCssClass: 'select2-dropdown-no-scroll'
                                        });
                                    }
                                }, 100);
                            };
                            
                            if (removeBtn) {
                                removeBtn.onclick = function(e) {
                                    console.log('=== REMOVE BUTTON CLICKED ===');
                                    e.preventDefault();
                                    
                                    // Clear fields
                                    ['relation2Type', 'relation2FirstName', 'relation2LastName', 'relation2Phone', 'relation2Email'].forEach(function(id) {
                                        const el = document.getElementById(id);
                                        if (el) {
                                            el.value = '';
                                            el.required = false; // Remove required when hiding
                                        }
                                    });
                                    
                                    // Clear address fields and remove required
                                    const addressFields = relation2Section.querySelectorAll('input[name^="relation2.address"]');
                                    addressFields.forEach(function(field) { 
                                        field.value = '';
                                        field.required = false;
                                    });
                                    
                                    // Remove validation states
                                    relation2Section.querySelectorAll('.is-valid, .is-invalid').forEach(function(el) {
                                        el.classList.remove('is-valid', 'is-invalid');
                                    });
                                    
                                    // Hide section
                                    relation2Section.style.display = 'none';
                                    addSection.style.display = 'block';
                                    if (showRelation2Field) showRelation2Field.value = 'false';
                                    
                                    // Destroy Select2
                                    if (window.jQuery && window.jQuery.fn.select2) {
                                        jQuery('#relation2Type').select2('destroy');
                                    }
                                };
                            }
                            
                            console.log('=== RELATIONS SCRIPT LOADED ===');
                        }
                        
                        // Initialize when page loads
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', initRelationsToggle);
                        } else {
                            initRelationsToggle();
                        }
                    </script>
                </div>
            </div>
        </section>
</body>
</html>
