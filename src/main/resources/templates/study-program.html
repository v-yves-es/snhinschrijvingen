<!DOCTYPE html>
<html lang="nl" 
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Studierichting kiezen - Inschrijvingen SNH</title>
</head>
<body>
    <section>
        <div th:replace="~{fragments/wizard :: wizard}"></div>

        <div class="container">
            <div class="form-card">
                <h1 class="form-title">Kies je studierichting</h1>
                
                <form class="form" th:action="@{/inschrijving/studierichting/__${registrationId}__}" method="post" id="studyProgramForm" data-validate="true" novalidate>
                    <input type="hidden" name="id" th:value="${registrationId}">
                    <input type="hidden" name="studyProgramId" id="selectedProgramId" th:value="${selectedProgramId}" required data-program-required="true">
                    <input type="hidden" name="studyYear" id="selectedYearInput" required>
                    
                    <!-- Year Selection -->
                    <div class="form-section">
                        <h2 class="form-section-title">Selecteer je jaar</h2>
                        
                        <div class="position-relative mb-4">
                            <label for="studyYear" class="form-label">
                                In welk jaar wil je je inschrijven?
                            </label>
                            <select id="studyYear" name="studyYearSelect" class="form-control form-select select2" data-placeholder="Kies een jaar..." required>
                                <option value="">Kies een jaar...</option>
                                <option th:each="year : ${availableYears}" 
                                        th:value="${year}" 
                                        th:selected="${selectedYear != null && selectedYear == year}"
                                        th:text="${year == 1 ? '1ste jaar' : year + 'de jaar'}">1ste jaar</option>
                            </select>
                            <div class="invalid-feedback">Gelieve een jaar te selecteren</div>

                            <!-- Info box for 2nd year (conditionally shown) -->
                            <div id="secondYearInfo" class="info-box info-box--info mt-3" style="display: none;">
                                <h2 class="info-box__title">Belangrijk voor het 2de jaar</h2>
                                <p class="info-box__text">
                                    Ook in het 2de jaar maken we de opsplitsing in plus- en accentklassen. 
                                    De klassenraad formuleerde voor uw zoon/dochter hierover een advies met Pasen op het rapport. 
                                    Voor de toewijzing aan een plus- of accentklas volgen we voor het 2de jaar steeds dat advies.
                                </p>
                                <p class="info-box__text">
                                    Mocht u het niet eens zijn met dat advies, neem dan gerust contact op met de school: 
                                    <a href="mailto:melissa.declercq@snh.be">melissa.declercq@snh.be</a>.
                                </p>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Study Programs Container (populated via JavaScript) -->
                    <div id="studyProgramsContainer" style="display: none;">
                        <div class="form-section">
                            <h2 class="form-section-title">Kies je richting</h2>
                            <div class="position-relative">
                                <div id="programsList"></div>
                                <div class="invalid-feedback" id="programsListFeedback"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extra Info Section -->
                    <div id="extraInfoSection" style="display: none;">
                        <div class="form-section">
                            <h2 class="form-section-title">Optioneel: Extra info bij twijfel</h2>
                            <div class="form-group">
                                <label for="extraInfo" class="form-label">
                                    Duid je voorkeursrichting aan, maar geef aan over welke andere keuzes je twijfelt.
                                </label>
                                <textarea id="extraInfo" 
                                          name="extraInfo" 
                                          class="form-control" 
                                          rows="4"
                                          th:text="${extraInfo}"
                                          placeholder="Bijvoorbeeld: Ik twijfel tussen Economie en Organisatie en Maatschappij en Welzijn..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a th:href="@{/inschrijving/leerling-info/__${registrationId}__}" class="btn btn--secondary">
                            <svg class="btn__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" style="transform: rotate(180deg);">
                                <path d="M8 1L15 8L8 15M15 8H1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Vorige
                        </a>
                        <button type="submit" class="btn btn--primary" id="submitBtn">
                            Volgende
                            <svg class="btn__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 1L15 8L8 15M15 8H1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // Wait for Select2 and jQuery to be loaded
                if (typeof jQuery === 'undefined') {
                    console.error('jQuery is not loaded!');
                    return;
                }
                
                jQuery(function($) {
                    const yearSelect = $('#studyYear');
                    const programsContainer = document.getElementById('studyProgramsContainer');
                    const programsList = document.getElementById('programsList');
                    const selectedProgramInput = document.getElementById('selectedProgramId');
                    const selectedYearInput = document.getElementById('selectedYearInput');
                    
                    const extraInfoSection = document.getElementById('extraInfoSection');
                    const secondYearInfo = document.getElementById('secondYearInfo');
                    
                    // Pre-selected values from server
                    const preSelectedYear = /*[[${selectedYear}]]*/ null;
                    const preSelectedProgramId = /*[[${selectedProgramId}]]*/ null;
                    
                    // Listen to Select2 change event
                    yearSelect.on('select2:select', function(e) {
                        const year = e.params.data.id;
                        selectedYearInput.value = year;
                        
                        if (!year) {
                            programsContainer.style.display = 'none';
                            extraInfoSection.style.display = 'none';
                            secondYearInfo.style.display = 'none';
                            return;
                        }
                        
                        // Show/hide 2nd year info box
                        if (year === '2') {
                            secondYearInfo.style.display = 'block';
                        } else {
                            secondYearInfo.style.display = 'none';
                        }
                        
                        // Fetch study programs for selected year
                        fetch(`/inschrijving/studierichting/programmas?year=${year}`)
                            .then(response => response.json())
                            .then(data => {
                                renderPrograms(data);
                                programsContainer.style.display = 'block';
                                extraInfoSection.style.display = 'block';
                                
                                // Re-select program if it was pre-selected
                                if (preSelectedProgramId) {
                                    const preSelectedRadio = document.getElementById('program_' + preSelectedProgramId);
                                    if (preSelectedRadio) {
                                        preSelectedRadio.checked = true;
                                        selectedProgramInput.value = preSelectedProgramId;
                                    }
                                } else {
                                    selectedProgramInput.value = '';
                                }
                            })
                            .catch(error => {
                                console.error('Error loading study programs:', error);
                                alert('Er is een fout opgetreden bij het laden van de richtingen.');
                            });
                    });
                    
                    // Trigger year selection on page load if pre-selected
                    if (preSelectedYear) {
                        yearSelect.val(preSelectedYear).trigger('change');
                        selectedYearInput.value = preSelectedYear;
                        
                        // Manually trigger the data fetch
                        const year = preSelectedYear;
                        if (year === '2') {
                            secondYearInfo.style.display = 'block';
                        }
                        
                        fetch(`/inschrijving/studierichting/programmas?year=${year}`)
                            .then(response => response.json())
                            .then(data => {
                                renderPrograms(data);
                                programsContainer.style.display = 'block';
                                extraInfoSection.style.display = 'block';
                                
                                if (preSelectedProgramId) {
                                    setTimeout(() => {
                                        const preSelectedRadio = document.getElementById('program_' + preSelectedProgramId);
                                        if (preSelectedRadio) {
                                            preSelectedRadio.checked = true;
                                            selectedProgramInput.value = preSelectedProgramId;
                                        }
                                    }, 100);
                                }
                            });
                    }
                    
                    function renderPrograms(data) {
                        programsList.innerHTML = '';
                        
                        if (data.hasGrouping) {
                            renderGroupedPrograms(data);
                        } else {
                            renderSimplePrograms(data);
                        }
                        
                        // Add event listeners to radio buttons
                        const radioButtons = programsList.querySelectorAll('input[type="radio"]');
                        radioButtons.forEach(radio => {
                            radio.addEventListener('change', function() {
                                selectedProgramInput.value = this.value;
                                selectedProgramInput.dataset.touched = 'true';
                                
                                // Mark all radio buttons in the group as touched
                                const radioGroup = document.querySelectorAll('input[name="program"]');
                                radioGroup.forEach(r => {
                                    r.dataset.touched = 'true';
                                });
                                
                                // Manually trigger validation for this radio button
                                // Remove validation classes from all radios first
                                radioGroup.forEach(r => {
                                    r.classList.remove('is-valid', 'is-invalid');
                                });
                                
                                // Add valid class to all radios since one is selected
                                radioGroup.forEach(r => {
                                    r.classList.add('is-valid');
                                });
                                
                                // Hide any error message
                                const feedbackElement = document.getElementById('programsListFeedback');
                                if (feedbackElement) {
                                    feedbackElement.style.display = 'none';
                                }
                            });
                        });
                    }
                    
                    function renderSimplePrograms(data) {
                        const html = data.programs.map((program, index) => `
                        <div class="form-check mb-2">
                            <input type="radio" 
                                   class="form-check-input" 
                                   name="program" 
                                   id="program_${program.id}" 
                                   value="${program.id}"
                                   ${index === 0 ? 'required' : ''}>
                            <label class="form-check-label" for="program_${program.id}">
                                ${program.name}
                            </label>
                        </div>
                    `).join('');
                    
                    programsList.innerHTML = html;
                    }
                    
                    function renderGroupedPrograms(data) {
                    let html = '';
                    let isFirstRadio = true;
                    
                    for (const [domain, orientations] of Object.entries(data.groupedPrograms)) {
                        const domainColor = data.domainColors[domain] || '#333';
                        
                        html += `
                            <div class="study-domain-group mb-4">
                                <h3 class="study-domain-title" style="color: ${domainColor}; border-left: 4px solid ${domainColor}; padding-left: 1rem;">
                                    ${domain}
                                </h3>
                        `;
                        
                        for (const [orientation, programs] of Object.entries(orientations)) {
                            html += `
                                <div class="study-orientation-group mb-3" style="margin-left: 1.5rem;">
                                    <h4 class="study-orientation-title" style="font-weight: 600; font-size: 1rem; margin-bottom: 0.75rem;">
                                        ${orientation}
                                    </h4>
                                    <div class="study-programs" style="margin-left: 1rem;">
                            `;
                            
                            programs.forEach(program => {
                                html += `
                                    <div class="form-check mb-2">
                                        <input type="radio" 
                                               class="form-check-input" 
                                               name="program" 
                                               id="program_${program.id}" 
                                               value="${program.id}"
                                               ${isFirstRadio ? 'required' : ''}>
                                        <label class="form-check-label" for="program_${program.id}">
                                            ${program.name}
                                        </label>
                                    </div>
                                `;
                                isFirstRadio = false;
                            });
                            
                            html += `
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                    
                    programsList.innerHTML = html;
                    }
                });
            });
        </script>
    </section>
</body>
</html>
